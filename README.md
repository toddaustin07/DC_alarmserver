# SmartThings Direct-connected Devices for Alarmserver

This repository contains files to implement alarmserver on a Raspberry Pi with device applications using SmartThings direct-connected device API.  A device application will be instantiated for each DSC zone, as well as a device application representing the DSC Panel.  Whereas in alarmserver's legacy SmartThings implementations, a separate Stay and Away panel was needed for automation linkage with SmartThings Home Monitor, here only one panel is needed, and no smartapp is required.

Zones device apps can optionally display a GUI window on the Raspbery Pi desktop (one for each zone).  Alternatively they can be run in background with logfiles.
The panel device app, in addition to handling the panel device interface to SmartThings, will also display a full DSC panel GUI window on the Pi desktop for local monitoring and control of the alarm system.  For those not running the Pi desktop, I can provide a non-GUI version upon request.

### Why Bother?!
Good question.  This implementation is more complex and requires more effort to set up than the original legacy platform alarmserver implementation.  However, based on statements from Samsung, it is expected that the way alarmserver currently connects to SmartThings (via graph URL) may be going away in the next year or two, and replaced by two options: cloud-connected (including smartapps), or direct-connected devices (the third option - hub-connected - is at present limited to zigbee and zwave devices).  Cloud-connected devices will require code to be implemented on AWS or your own self-managed internet server.  Direct-connected devices provides a way to keep all custom code running locally on a Raspberry Pi.  

Also expected to be sunset are all groovy-based DTHs and applications, which the current implementation of alarmserver also depends on.

At this time, we don't know exactly when these things will be sunset, but if/when it happens, anyone running alarmserver will need a new solution.  This project lets you 'future-proof' your DSC integration with SmartThings since it utilizes the 'new platform' implementation methods.

### Limitations
- Only one DSC partition is currently supported
- Smoke and CO2 zones have not yet been tested
- In the legacy SmartThings platform, the alarmserver zone devices were automatically generated by a smartapp - a nice feature.  Unfortunately here they will need to be manaually defined in the Developer Workspace as part of device profile setup, and initially onboarded via the mobile app one at a time.  However this is a one-time-only setup task.

#### New to Alarmserver?
Alarmserver is a program that will interface with an EyezOn Envisalink module that is wired to your DSC system board.  Alarmserver provides a software interface to/from the Envisalink via Ethernet so you can control, and get status from, your DSC alarm system.  It was originally implemented to integrate with SmartThings via the graph URL, but that option may be going away sometime in 2021 or 2022 as SmartThings evolves it's platform.  Ideally, you already have Alarmserver working in this original configuration, so that you've already configured your zones and have it successfully talking to the Envisalink and your DSC alarm system.  

For those new to alarmserver itself, please ask for assistance in the SmartThings Community topic for alarmserver.

#### Escape plan
Worried about messing up your current alarmserver/SmartThings setup?  Rest easy, because at any time you can revert back to your current setup quite easily by simply restoring your original alarmserver.cfg file which will be saved for you before it is modified for a direct-connect configuration.  Alarmserver itself is not touched by this project (just it's config file), nor are your current SmartThings devices or DTHs.

## Pre-requisites
- Installed, configured, and tested Direct-connect enablement package for Raspberry Pi (rpi-st-device): https://toddaustin07.github.io/
- Installed and configured alarmserver package: https://github.com/rtorchia/DSC-Envisalink/tree/master/alarmserver
- SmartThings personal token: https://smartthings.developer.samsung.com/docs/auth-and-permissions.html

## Installation Steps

### 1. Creation of SmartThings custom capabilities 
The devices that represent the zones and panel of the alarm system utilize a combination of 'stock' SmartThings device capabilities plus a number of 'custom' capabilities.  Unfortunately under the current SmartThings platform, custom capabilities utilized for direct connect devices must be created under your own SmartThings developer account.  There currently is no way to directly utilize custom capabilities created by someone else (unless of course they are formally certified by SmartThings).  To overscome this limitation, I have provided a GUI-based Python3 script 'stdevmake.py' that utilizes the SmartThings Restful API to automate the 'cloning' of the needed custom capabilities and their companion presentations into your SmartThings namespace.  You only need to provide your SmartThings personal token. 

You will later select these new custom capabilities, created under your account, as part of the device profile setup in the Developer Workspace.

When you first run stdevmake.py, you must go into Preferences->configure to setup your profile info including Personal Token, namespace id, etc.  You will then clone each device configuration needed (panel, motion, contact, smoke, c02) by using File-open to load the applicable 'seed' device config file provided in this package (DSC_panel.json, DSC_motion.json, etc) and cloning it to your account.  All JSON returned by SmartThings is saved locally.

You can also later use this tool to update device configs, capabilities and presentations by modifying the files in the JSON subdirectories and using the tool to re-submit them to SmartThings (as an alternative to CLI or Postman). 

### 2. Pi Config Setup
Next run the bash script 'ASdevsetup' using one argument that is the full pathname of your alarmserver.cfg file.  The script will read your alarmserver.cfg file to get your defined zones, set up device subdirectories, create device serial numbers, initialize a device loader script (loaddevs), and modify alarmserver.cfg.  You will need to know your SmartThings namespace which gets assigned to you when you created your custom capabilities.  (The stdevmake tool helps you discover your namespace id)

Upon successful completion of ASdevsetup, a file called 'serialnums' will be created that contains a sorted list of the created device serial numbers and public keys that you can use to copy and paste into the Developer Workspace device profiles (under 'Test Devices') later on.  Note: For your convenience, the serialnums file will automatically be displayed in a pop up mousepad GUI window.  Be sure to expand the window width if needed for proper formatting.

Note: the ASdevsetup script depends on the core SDK repository tool 'stdk-keygen', so prior installation via my rpi-st-devices package is required.

### 3. Create SmartThings device profiles
This is done in the Developer Workspace.  One project/device profile must be created for each TYPE of device you are using (e.g. panel, contact, motion, smoke, CO2)
Recommended parameters to use in the Developer Workspace device profile definition screens are as follows:
```
                               DSC Panel              Contact Device          Motion Device            Smoke Detector          CO2 Detector
                               --------------------   --------------------    ---------------------    --------------------    ----------------------
Device Profile
  Name                         DSC_Panel              DSC_Contact             DSC_Motion               DSC_Smoke               DSC_CO2
  Version                      0.1                    0.1                     0.1                      0.1                     0.1
  Device Type                  Switch                 ContactSensor           MotionSensor             SmokeDetector           SmokeDetector
  Components & Capabilities*   Health Check (opt)     Health Check (opt)      Health Check (opt)       Health Check (opt)      Health Check (opt)
                               partitionStatus        contactSensor           motionSensor             smokeDetector           carbonMonoxideDetector
                               partitioncommand       contactStatus           motionStatus             smokeStatus             co2Status
                               dscdashswitch          zonebypass              zonebypass               zonebypass              zonebypass
                               dscstayswitch
                               dscawayswitch
                               dscselectswitch

Onboarding
  Onboarding name                                            <<  DSC Zone Device >>
  Authentication type                                            << ED25519 >>
  Setup ID                                                         << 02 >>
  Instructions                                              << whatever you'd like >>
  Confirm Device                                              << 'Just Works' >>

Product Info
  Category                                                      << WiFi/Hub >>
  Availability                                         << United States (or other) >>
  Model Number / SKU           DSC_PANEL001           DSC_CONTACT001           DSC_MOTION001           DSC_SMOKE001            DSC_CO2001

 
  
  UI Display*                                    << 'Customize through device configuration file' >>

```
#### Components & Capabilities
All are defined under 'main' component.  All capabilities besides 'Health Check' are custom that you built in prior step. Filter the capability list for 'My Capabilities', and you should see all the ones you have created.  Select the corresponding capabilities listed in the table above.

#### UI Display
You will choose the option to 'Customize through device configuration file'. First download the file using the link on the page.  You will upload a new file, but you need to get the mnmn and VID values from the downloaded file first.  Edit the applicable device configuration json file provided in the json/deviceconfigs directory of this repository (deviceConfigST_panel.json, deviceConfigST_contact.json, deviceConfigST_motion.json).  Update the file with the mnmn and VID from the file you downloaded.  Then do a global search and replace of the five asterisks with your unique capability id prefix.  Save the file and then upload it.  Complete these steps for each project/device profile (panel, contact, motion, etc).

#### Test Devices (this is a noun, not a verb!)
In this part of the Developer Workspace setup, you identify the serial numbers and keys of the devices you'll be using under each profile.  You can reference the serialnums file that was created earlier by the ASdevsetup tool for a convenient list by device type.  On the Developer Workspace Test Devices screen under each device type profile, click on the 'REGISTER NEW DEVICE' button and copy/paste the respective serial number and public key from the serialnums file.

### 3b. Download onboarding_config.json files
When complete with the above device profile definition tasks, **onboarding_config.json** files - generated by the Developer Workspace - must be downloaded and placed in each of the appropriate device directories (one json file per device type).  Be careful to place the 'DSC_Contact' onboarding_config.json file into all the zone device directories that represent contact devices, 'DSC_Motion' onboarding_config.json file into all the zone device directories that represent motion devices, etc.



### Device Onboarding Helper 
You will use the onboarding helper script 'onboard', and the SmartThings mobile app, to connect with each of the zone & panel device apps on your Raspberry Pi via wireless in order to complete onboarding of each device (one per zone + panel). When you are ready to proceed, run the onboard script. The first thing it does is verify you have all necessary files installed in your device subdirectories (most of this should have been all taken care of when you ran the ASdevsetup script). It will confirm that you have downloaded your onboarding_config.json files into the device subdirectories and will create a QR code for each device (used during onboarding). Once everything is verified and there are no errors, it will proceed to launch your device apps one at a time and step you through the onboarding process.

This script can be re-run again at a later time if needed and it will step through onboarding for only those device apps that have not already been onboarded.



### Additional scripts provided
- startall - master startup script to load (1) zone device apps & panel (post initial onboarding), (2) DSCmanager, (3) alarmserver; this is optional- you can configure loading anyway you like, e.g. auto-load at boot time through systemd, etc
- buildloader - used by ASdevsetup; creates loaddevs script that is used by DSCmanager to start up each device app (zones + panel)
- loaddevs - invoked by DSCmanager to load all device apps at startup 
- STdevsn - list serial numbers associated with each device app


## Manual Setup Tasks





## Full system startup

Once all device apps have been initially onboarded and running, you can then start DSCmanager and then alarmserver to get everything operating.  

Required arguments for each application are as follows:
```
DSCzone_n -sock <UNIX named socket name> - type <contact | motion | smoke | c02> [-gui] [-name <"zone name">]
DSCpanel_1 -sock <UNIX named socket name> -zones <# of zones>
DSCManager
python3 alarmserver -c <alarmserver.cfg file path/name>
```
For subsequent startup, you can modify and use the loaddevs script to load your device apps any way you wish (in background, in a terminal, with GUI, at boot time, etc.).  Some example loaddevs alternatives are provided for reference.  Recommended loading order for everything is 1) device apps, 2) DSCmanager, 3) alarmserver.  The 'startall' script can be used/modified to do this.

## Using your DSC devices in the SmartThings Mobile App
The first thing you will want to do after your devices are onboarded and happily humming away on your Pi is to go into the mobile app and group the DSC devices into a room, and rename each of them to something useful.  I use of combination of zone number (Z1) and VERY abbreviated zone description - short enough to fit on the dashboard card.  

The zone devices have no action buttons on the dashboard - just the status of the device (open/closed, motion/no motion, etc.).  On the details screen, you'll see a zone status field, which most of the time will show the open/close-type status of the device, but may also show other states such as alarm, trouble, bypassed, etc.  Also on the details screen is a slider switch you can use to turn on and off bypass state for the zone.

The panel device has a bit more function.  On the dashboard, the button is used to arm or disarm the partition.  Whether it performs an arm-away or arm-stay is configured on the details screen (explained below).  The state shown on the dashboard is whatever the DSC is reporting such as ready, not ready, exit delay, armed-away or armed-stay, alarm, etc.  I have eliminated the force-ready status since it's not very useful and in the old alarmserver implementation always caused a crazy amount of constant state changes, filling up the log and messages everytime someone opened a door or walked by a motion sensor.

The dashboard icon on the panel device is supposed to be gray when in Ready state, and color highlighted for anything else.  There is currently a SmartThings mobile app bug (reported) where this is not working on IOS-based devices.

The panel device detail screen has a number of features.  First is the partition status - same as what is shown on the dashboard.  Next are discrete buttons to arm stay or arm away (or disarm afterwards).  Then there is a button to bring up a list of additional partition commands that can be invoked.  Finally there is a toggle button to configure what happens when you tap the button on the dashboard.  It can be set to either type=arm-away or type=arm-stay, whichever you prefer.  Remember you can always go to the details screen to directly arm either way, no matter how the dashboard button is configured.  These detail screen discrete arm buttons will probably be what you want to use for automation 'THEN' actions (and Partition Status attribute for IF conditions).

## Operational Specifics:

Alarmserver is re-directed via its config file to send/receive messages to a locally running process on your Pi (DSCmanager), rather than to the former SmartThings graph URL.  DSCmanager then acts as traffic coordinator to forward messages to the appropriate zone/panel device app (DSCzone).  The device apps are connected to SmartThings via the direct-connect API using the ST core SDK (which uses MQTT in the background).  Messages from SmartThings (commands and state changes) are received directly by the respective Pi device app, which in turn routes commands back down to alarmserver via DSCmanager.  UNIX named sockets are used for all IPC between DSCmanager and device apps because it is fast and efficient.  All applications are written and compiled C for optimal speed and compactness.  

The DSC devices represented in your SmartThings mobile app will be all new for this directly-connected implementation of alarmserver.  For those currently using alarmserver, your current devices will not be effected or used.  In fact, if you don't delete those original alarmserver devices, you can revert back to the prior operation of alarmserver at any time by simply replacing alarmserver.cfg with your original file, which was saved as alarmserver.cfg_ORIG.

GUI displays are implemented with GTK3+.  Currently, gui windows are optional for the zone device apps, but required for the panel app.  If it turns out there is little interest in the GUIs, I may remove that code for the sake of further efficiency, since it does increase the amount of resident memory required for each app whether you use the GUI option or not.

Loading of device apps is initiated by DSCmanager through a bash script so that users can modify it for preference of running apps in foreground vs. background, piping output to logfiles, GUI option selection, etc.



### Tips
#### Ensure your /etc/hosts file contains these entries:
```
127.0.0.1       localhost
127.0.1.1       raspberrypi
192.168.1.100   EnvisaLink      <<< or whatever IP address you are using
```
#### The device onboarding process 
The procedure of initially provisioning your devices via mobile phone wireless can be finicky.  Retries may be needed if a failure is encountered.  Here are some additional tips to follow:
- Stay within 4 feet or so of your Pi when connecting your mobile to the Pi
- If onboarding manually (i.e. not using the onboarding helper script), use gpicview to display the QR code located in each device directory
- Be sure that you've given the Pi device app enough time to load and get in to a 'listen' state before you get too far in the mobile app
- If the mobile app fails or seems to be stuck, unload and reload the app before trying again; the 'retry' option in the mobile app rarely works
- If you wait long enough the Pi device app will usually time out after errors and return your wireless state back to normal.  If you Ctrl-c out of the app early, your wireless may be left in the 'SoftAP' state.  If this happens use the ~/rpi-st-device/resetAP utility to reset your wireless state before restarting the device app.
- Monitor the log messages coming from the device app; they can help determine where errors may be occuring.  Copy and paste them to a file to provide later if asking for help.
- Once the mobile app is done exchanging info with your Pi and you've selected a wireless AP for the Pi to reconnect to (moot if you have an ethernet connection), the Pi device app will then wait for the SmartThings MQTT server to respond back with successful device registration.  This can take up to 40 seconds or more from the time you had selected an AP in the mobile app, so be patient.

See the detail configuration guide of the rpi-st-device package for additional information.
