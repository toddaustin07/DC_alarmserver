# SmartThings Direct-connected Devices for Alarmserver

This repository contains files to implement alarmserver on a Raspberry Pi with device applications using SmartThings direct-connected device API.  A device application will be instantiated for each DSC zone, plus a device application representing the DSC Panel.  Whereas in legacy SmartThings implementations, a separate Stay and Away panel was needed for automation linkage with SmartThings Home Monitor, here only one panel is needed.

Zones device apps can optionally display a GUI window on the Raspbery Pi desktop (one for each zone).  Alternatively they can be run in background with logfiles.
The panel application, in addition to handling the panel device interface to SmartThings, will also display a full DSC panel GUI window on the Pi desktop for local monitoring and control of the alarm system.

### Limitations
- Only one DSC partition is currently supported
- Smoke and CO2 zones have not been tested
- In the 'old' implementation of alarmserver, one nice thing was that the SmartThings devices were automatically generated by a smartapp.  Here they will need to be manaually defined in the Developer Workspace, and initially onboarded via the mobile app one at a time (a one-time setup task)

## Pre-requisites
- Direct-connect enablement github package for Raspberry Pi (rpi-st-device): https://toddaustin07.github.io/
- Installed and configured alarmserver package: https://github.com/rtorchia/DSC-Envisalink/tree/master/alarmserver
- SmartThings personal token: https://smartthings.developer.samsung.com/docs/auth-and-permissions.html

## Automated Setup Tools

### ASdevsetup
Run this script using one argument as full pathname of your alarmserver.cfg file.  It will read your alarmserver.cfg file to get the defined zones and will then automate creation of device serial numbers and set up each zone device subdirectory with required files.  Note: this script depends on prior install and setup completion of rpi-st-device package, which configures your Pi to successfully onboard and run ST direct-connnected device apps.

### Device Onboarding Helper (wip)
Run this script once everything is configured & installed: ASdevsetup is complete, device projects are defined in Developer Workspace, and onboarding_config.json files have been downloaded.
This script will automate the creation of QR codes for each device and ensure everything is prepared for initial provisioning of all device apps (zone + panel)

### Additional scripts
- startall - master startup script to load (1) zone device apps & panel (post initial onboarding), (2) DSCmanager, (3) alarmserver
- buildloader - used by ASdevsetup; creates loaddevs script that loads/starts each device app (zones + panel)
- STdevsn - list serial numbers associated with each device app


## Manual Setup Tasks

### Create SmartThings custom capabilities 
A python script is provided in the json/capabilities directory that will create all custom capabilities and presentations under your account.  First edit the makecapabilities.py script with your SmartThings personal token and then run it within the json directory.  It will iterate through the provided json files to create 10 custom capabilities along with their presentations via the SmartThings API.  Returned json strings are written to file for each capability.  Note your assigned capability id prefix.

### Create SmartThings device profiles
This is done in the Developer Workspace.  One project/device profile must be created for each TYPE of device you are using (panel, contact, motion, smoke, CO2)
Recommended parameters to use in the Developer Workspace screens are as follows:
```
                               DSC Panel              Contact Device          Motion Device        
                               --------------------   --------------------    ---------------------
Device Profile
  Name                         DSC_Panel              DSC_Contact             DSC_Motion     
  Version                      0.1                    0.1                     0.1
  Device Type                  Switch                 ContactSensor           MotionSensor
  Components & Capabilities*   Health Check (opt)     Health Check (opt)      Health Check (opt)
                               partitionStatus        contactStatus           motionStatus
                               partitioncommand       zonebypass              zonebypass
                               dscdashswitch
                               dscstayswitch
                               dscawayswitch
                               dscselectswitch

Onboarding
  Onboarding name                               <<  DSC Zone Device >>
  Authentication type                                << ED25519 >>
  Setup ID                                              << 02 >>
  Instructions                                  << whatever you'd like >>

Product Info
  Category                                           << WiFi/Hub >>
  Availability                                 << United States (or other) >>
  Model Number / SKU           DSC_PANEL001           DSC_CONTACT001           DSC_MOTION001

 
  
  UI Display*                         << 'Customize through device configuration file' >>

```
#### Components & Capabilities
All are defined under 'main' component.  All capabilities besides 'Health Check' are custom that you built in prior step. Filter the capability list for 'My Capabilities', and you should see all the ones you have created.  Select the corresponding capabilities listed in the table above.

#### UI Display
You will choose the option to 'Customize through device configuration file'. First download the file using the link on the page.  You will upload a new file, but you need to get the mnmn and VID values from the downloaded file first.  Edit the applicable device configuration json file provided in the json/deviceconfigs directory of this repository (deviceConfigST_panel.json, deviceConfigST_contact.json, deviceConfigST_motion.json).  Update the file with the mnmn and VID from the file you downloaded.  Then do a global search and replace of the five asterisks with your unique capability id prefix.  Save the file and then upload it.  Complete these steps for each project/device profile (panel, contact, motion, etc).

### Download onboarding_config.json files
When complete with the above, onboarding_config.json files - generated by the Developer Workspace when you define your device profiles - must be downloaded and placed in each of the appropriate device directories (one json file per device type)


### Initial onboarding/provisioning of each zone device + panel device using mobile app
You will use the onboarding helper script (wip) and SmartThings mobile app to connect with each of the zone & panel device apps on your Raspberry Pi via wireless in order to complete onboarding of each device (one per zone + panel).


### Operational Specifics:

Alarmserver is re-configured to send/receive via tcp sockets to a locally running process on your Pi (DSCmanager), rather than to SmartThings.  DSCmanager then acts as traffic manager to forward messages to the appropriate zone/panel device app.  The device apps are connected to SmartThings via the direct-connect API using the ST core SDK.  Messages from SmartThings (commands and state changes) are received directly by the respective device app, which in turn routes commands back down to alarmserver via DSCmanager.  UNIX named sockets are used for all IPC between DSCmanager and device apps.  All applications are written and compiled C for optimal speed and efficiency.  GUI displays are implemented with GTK3+.

Loading of device apps is initiated by DSCmanager through a bash script so that user's can modify it for preference of running apps in foreground vs. background, piping output to logfiles, GUI option selection, etc.
